#!/bin/bash

# Find the next ls in PATH search order
real_ls=$(which -a ls | grep -A1 "$0" | tail -1)

# Silently bypass if not hterminal
if ! ishterminal; then
  exec $real_ls "$@"
fi

# Bypass if any switches are passed
for i in "$@"; do
  [[ ${i:0:1} == - ]] && exec $real_ls "$@"
done

hterminal begin
in_list=0
ls "$@" | hterminal escape | while read file; do
  if [[ -z $file ]]; then
    echo -n "</multi-column-list>"
    in_list=0
  elif [[ ${file: -1} == ":" ]]; then
    echo -n "<strong>$file</strong>"
  else
    [[ $in_list == 0 ]] && echo -n "<multi-column-list>"
    in_list=1
    # -F Display a slash (`/') immediately after each pathname that is a directory, an asterisk (`*')
    #    after each that is executable, an at sign (`@') after each symbolic link, an equals sign (`=')
    #    after each socket, a percent sign (`%') after each whiteout, and a vertical bar (`|') after
    #    each that is a FIFO.
    indicator=${file: -1}
    mime=""
    if [[ $indicator == "/" ]]; then
      file=${file%?}
      mime="mime=\"application/x-directory\""
    fi
    echo -n "<file-pill ${mime}>$file</file-pill>"
  fi
done
echo -n "</multi-column-list>"
hterminal end
